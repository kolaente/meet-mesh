# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Meet Mesh is a self-hosted scheduling application combining Calendly-style booking links (1:1 scheduling with real-time calendar availability) and Doodle-style group polls (many-to-many coordination with voting). Single organizer per deployment.

**Architecture:** Go backend + SvelteKit frontend in a monorepo, compiled to a single embedded binary.

## Build & Development Commands

```bash
# Full build: frontend → code generation → Go binary
make build

# Build Go binary only (assumes frontend already built)
make build-api

# Build frontend and copy to api/embedded/dist
make frontend-dist

# Regenerate Go code from OpenAPI spec (after modifying openapi.yaml)
make generate

# Clean all build artifacts
make clean

# Development (run in separate terminals)
cd frontend && pnpm dev
cd api && go run ./cmd
```

### Frontend Commands

```bash
cd frontend
pnpm dev              # Development server (auto-regenerates API types)
pnpm build            # Production build
pnpm check            # TypeScript/Svelte type checking
pnpm check:watch      # Type checking in watch mode
pnpm generate:api     # Regenerate TypeScript types from OpenAPI spec
```

## Architecture

### Tech Stack

- **Backend:** Go 1.25, ogen (OpenAPI codegen), GORM, SQLite
- **Frontend:** SvelteKit with Svelte 5 (runes), Tailwind CSS v4, bits-ui
- **Auth:** OIDC (organizer), JWT tokens (email actions)
- **Calendar:** CalDAV via github.com/emersion/go-webdav
- **Email:** SMTP with gomail

### Key Directories

```
api/
├── cmd/main.go           # Entry point, wires up server
├── openapi.yaml          # API specification (source of truth)
├── gen/                  # Generated by ogen (DO NOT EDIT)
├── handler*.go           # Request handlers split by domain
├── models.go             # GORM data models
├── security.go           # OIDC & token validation
└── embedded/dist/        # Built frontend assets (generated)

frontend/
├── src/lib/
│   ├── components/       # Svelte components (ui/, booking/, poll/, dashboard/)
│   ├── api/
│   │   ├── client.ts     # API client wrapper
│   │   └── generated/    # Generated from OpenAPI spec (DO NOT EDIT)
│   └── stores/           # Svelte stores (auth, toast)
└── src/routes/
    ├── (dashboard)/      # Organizer views (auth required)
    ├── (public)/p/[slug] # Guest booking/poll pages
    └── (actions)/        # Email action pages
```

### OpenAPI-First Development

1. Modify `api/openapi.yaml` first
2. Run `make generate` to regenerate Go types/interfaces
3. Implement handler methods in `api/handler_*.go`
4. Run `cd frontend && pnpm generate:api` for TypeScript types

### Handler Organization

Handlers are split by domain: `handler_auth.go`, `handler_links.go`, `handler_bookings.go`, `handler_slots.go`, `handler_votes.go`, `handler_public.go`, `handler_actions.go`, `handler_calendar.go`

### Authentication Model

| User Type | Method | Use Case |
|-----------|--------|----------|
| Organizer | OIDC session cookie | Dashboard, link management |
| Guest | None | Booking/voting (anonymous) |
| Email Actions | JWT in query param | Approve/decline via email links |

### Data Flow

- CalDAV availability is queried real-time on each request (not cached)
- Frontend is embedded in Go binary for single-binary deployment
- Enums are integer-based in OpenAPI spec with `x-enum-varnames`

## Configuration

Copy `config.example.yaml` to `config.yaml`. Contains OIDC provider, SMTP, database path settings. Secrets can use environment variable interpolation: `${VAR_NAME}`.

## Documentation

- `docs/spec.md` - Feature specification and user flows
- `docs/technical-overview.md` - Detailed architecture and data models

## Issue Tracking (bd/beads)

This project uses **bd** (beads) for issue tracking. Run `bd onboard` to get started.

### Quick Reference

```bash
bd ready              # Find available work
bd show <id>          # View issue details
bd update <id> --status in_progress  # Claim work
bd close <id>         # Complete work
bd sync               # Sync with git
```

### Landing the Plane (Session Completion)

**When ending a work session**, you MUST complete ALL steps below. Work is NOT complete until `git push` succeeds.

**MANDATORY WORKFLOW:**

1. **File issues for remaining work** - Create issues for anything that needs follow-up
2. **Run quality gates** (if code changed) - Tests, linters, builds
3. **Update issue status** - Close finished work, update in-progress items
4. **PUSH TO REMOTE** - This is MANDATORY:
   ```bash
   git pull --rebase
   bd sync
   git push
   git status  # MUST show "up to date with origin"
   ```
5. **Clean up** - Clear stashes, prune remote branches
6. **Verify** - All changes committed AND pushed
7. **Hand off** - Provide context for next session

**CRITICAL RULES:**
- Work is NOT complete until `git push` succeeds
- NEVER stop before pushing - that leaves work stranded locally
- NEVER say "ready to push when you are" - YOU must push
- If push fails, resolve and retry until it succeeds
