openapi: 3.0.3
info:
  title: Meet Mesh API
  version: 1.0.0
  description: Self-hosted scheduling API

servers:
  - url: /api

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session
    actionToken:
      type: apiKey
      in: query
      name: token

  schemas:
    Error:
      type: object
      required: [message]
      properties:
        message:
          type: string

    SlotType:
      type: integer
      enum: [1, 2, 3]
      description: "1=time, 2=full_day, 3=multi_day"

    LinkStatus:
      type: integer
      enum: [1, 2]
      description: "1=active, 2=closed"

    BookingStatus:
      type: integer
      enum: [1, 2, 3]
      description: "1=pending, 2=confirmed, 3=declined"

    CustomFieldType:
      type: integer
      enum: [1, 2, 3, 4, 5]
      description: "1=text, 2=email, 3=phone, 4=select, 5=textarea"

    VoteResponse:
      type: integer
      enum: [1, 2, 3]
      description: "1=yes, 2=no, 3=maybe"

    AvailabilityRule:
      type: object
      required: [days_of_week, start_time, end_time]
      properties:
        days_of_week:
          type: array
          items:
            type: integer
            minimum: 0
            maximum: 6
        start_time:
          type: string
          pattern: "^[0-2][0-9]:[0-5][0-9]$"
        end_time:
          type: string
          pattern: "^[0-2][0-9]:[0-5][0-9]$"

    CustomField:
      type: object
      required: [name, label, type, required]
      properties:
        name:
          type: string
        label:
          type: string
        type:
          $ref: '#/components/schemas/CustomFieldType'
        required:
          type: boolean
        options:
          type: array
          items:
            type: string

    EventTemplate:
      type: object
      properties:
        title_template:
          type: string
        description_template:
          type: string
        location:
          type: string

    User:
      type: object
      required: [id, email]
      properties:
        id:
          type: integer
        email:
          type: string
        name:
          type: string
        avatar_url:
          type: string
          description: URL to the user's avatar image, or empty if no avatar is set

    CalendarConnection:
      type: object
      required: [id, server_url, username]
      properties:
        id:
          type: integer
        server_url:
          type: string
        username:
          type: string
        calendar_urls:
          type: array
          items:
            type: string
        write_url:
          type: string

    CalendarTestResult:
      type: object
      required: [success, events]
      properties:
        success:
          type: boolean
        error:
          type: string
        events:
          type: array
          items:
            type: object
            required: [title, start, end]
            properties:
              title:
                type: string
              start:
                type: string
                format: date-time
              end:
                type: string
                format: date-time

    DiscoveredCalendar:
      type: object
      required: [url, name]
      properties:
        url:
          type: string
          description: Full CalDAV URL path to the calendar
        name:
          type: string
          description: Display name of the calendar
        description:
          type: string
        supported_components:
          type: array
          items:
            type: string
          description: e.g. VEVENT, VTODO

    CalendarDiscoveryResult:
      type: object
      required: [success, calendars]
      properties:
        success:
          type: boolean
        error:
          type: string
        calendars:
          type: array
          items:
            $ref: '#/components/schemas/DiscoveredCalendar'

    BookingLink:
      type: object
      required: [id, slug, name, status]
      properties:
        id:
          type: integer
        slug:
          type: string
        name:
          type: string
        description:
          type: string
        status:
          $ref: '#/components/schemas/LinkStatus'
        auto_confirm:
          type: boolean
        slot_duration_minutes:
          type: integer
          description: Duration of each bookable slot in minutes (deprecated, use slot_durations_minutes)
          default: 30
        slot_durations_minutes:
          type: array
          items:
            type: integer
            minimum: 5
            maximum: 480
          description: Available slot durations in minutes. If empty, slot_duration_minutes is used.
          example: [15, 30, 60]
        buffer_minutes:
          type: integer
          description: Buffer time between slots in minutes
          default: 0
        require_email:
          type: boolean
        meeting_link:
          type: string
          description: Video meeting link (Zoom, Google Meet, etc.) to include in calendar events
        availability_rules:
          type: array
          items:
            $ref: '#/components/schemas/AvailabilityRule'
        custom_fields:
          type: array
          items:
            $ref: '#/components/schemas/CustomField'
        event_template:
          $ref: '#/components/schemas/EventTemplate'
        created_at:
          type: string
          format: date-time

    Poll:
      type: object
      required: [id, slug, name, status]
      properties:
        id:
          type: integer
        slug:
          type: string
        name:
          type: string
        description:
          type: string
        status:
          $ref: '#/components/schemas/LinkStatus'
        show_results:
          type: boolean
        require_email:
          type: boolean
        custom_fields:
          type: array
          items:
            $ref: '#/components/schemas/CustomField'
        created_at:
          type: string
          format: date-time

    PollOption:
      type: object
      required: [id, type, start_time, end_time]
      properties:
        id:
          type: integer
        type:
          $ref: '#/components/schemas/SlotType'
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time

    Slot:
      type: object
      required: [id, type, start_time, end_time]
      properties:
        id:
          type: integer
        type:
          $ref: '#/components/schemas/SlotType'
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time

    Booking:
      type: object
      required: [id, slot, guest_email, status]
      properties:
        id:
          type: integer
        slot:
          $ref: '#/components/schemas/Slot'
        guest_email:
          type: string
        guest_name:
          type: string
        status:
          $ref: '#/components/schemas/BookingStatus'
        custom_fields:
          type: object
          additionalProperties:
            type: string
        created_at:
          type: string
          format: date-time

    Vote:
      type: object
      required: [id, responses]
      properties:
        id:
          type: integer
        guest_name:
          type: string
        guest_email:
          type: string
        responses:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/VoteResponse'
        custom_fields:
          type: object
          additionalProperties:
            type: string
        created_at:
          type: string
          format: date-time

    VoteTally:
      type: object
      required: [option_id, yes_count, no_count, maybe_count]
      properties:
        option_id:
          type: integer
        yes_count:
          type: integer
        no_count:
          type: integer
        maybe_count:
          type: integer

paths:
  /auth/login:
    get:
      operationId: initiateLogin
      summary: Redirect to OIDC provider
      responses:
        '302':
          description: Redirect to OIDC provider
          headers:
            Location:
              description: URL to redirect to
              schema:
                type: string
            Set-Cookie:
              description: State cookie for CSRF protection
              schema:
                type: string

  /auth/callback:
    get:
      operationId: authCallback
      summary: Handle OIDC callback
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
        - name: state
          in: query
          required: true
          schema:
            type: string
      responses:
        '302':
          description: Redirect to dashboard
          headers:
            Location:
              description: URL to redirect to
              schema:
                type: string
            Set-Cookie:
              description: Session cookie
              schema:
                type: string
        '400':
          description: Invalid callback
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      operationId: logout
      summary: Clear session
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Logged out

  /auth/me:
    get:
      operationId: getCurrentUser
      summary: Get current user
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      operationId: updateCurrentUser
      summary: Update current user profile
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: Display name for the organizer
      responses:
        '200':
          description: Updated user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /calendars:
    get:
      operationId: listCalendars
      summary: List calendar connections
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Calendar connections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CalendarConnection'

    post:
      operationId: addCalendar
      summary: Add calendar connection
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [server_url, username, password]
              properties:
                server_url:
                  type: string
                username:
                  type: string
                password:
                  type: string
                calendar_urls:
                  type: array
                  items:
                    type: string
                write_url:
                  type: string
      responses:
        '201':
          description: Calendar added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalendarConnection'

  /calendars/{id}:
    delete:
      operationId: removeCalendar
      summary: Remove calendar connection
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Calendar removed

  /calendars/{id}/test:
    post:
      operationId: testCalendar
      summary: Test calendar connection by fetching events
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Test results with events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalendarTestResult'
        '404':
          description: Calendar not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /calendars/discover:
    post:
      operationId: discoverCalendars
      summary: Discover available calendars from a CalDAV server
      tags:
        - calendars
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [server_url, username, password]
              properties:
                server_url:
                  type: string
                username:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: Discovery result with available calendars
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalendarDiscoveryResult'

  # Booking Links endpoints
  /booking-links:
    get:
      operationId: listBookingLinks
      summary: List all booking links
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Booking links
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BookingLink'

    post:
      operationId: createBookingLink
      summary: Create a booking link
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                description:
                  type: string
                auto_confirm:
                  type: boolean
                slot_duration_minutes:
                  type: integer
                  default: 30
                slot_durations_minutes:
                  type: array
                  items:
                    type: integer
                    minimum: 5
                    maximum: 480
                  description: Available slot durations in minutes
                buffer_minutes:
                  type: integer
                  default: 0
                require_email:
                  type: boolean
                meeting_link:
                  type: string
                  description: Video meeting link (Zoom, Google Meet, etc.)
                availability_rules:
                  type: array
                  items:
                    $ref: '#/components/schemas/AvailabilityRule'
                custom_fields:
                  type: array
                  items:
                    $ref: '#/components/schemas/CustomField'
                event_template:
                  $ref: '#/components/schemas/EventTemplate'
      responses:
        '201':
          description: Booking link created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookingLink'

  /booking-links/{id}:
    get:
      operationId: getBookingLink
      summary: Get booking link details
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Booking link details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookingLink'

    put:
      operationId: updateBookingLink
      summary: Update a booking link
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                status:
                  $ref: '#/components/schemas/LinkStatus'
                auto_confirm:
                  type: boolean
                slot_duration_minutes:
                  type: integer
                slot_durations_minutes:
                  type: array
                  items:
                    type: integer
                    minimum: 5
                    maximum: 480
                buffer_minutes:
                  type: integer
                require_email:
                  type: boolean
                meeting_link:
                  type: string
                  description: Video meeting link (Zoom, Google Meet, etc.)
                availability_rules:
                  type: array
                  items:
                    $ref: '#/components/schemas/AvailabilityRule'
                custom_fields:
                  type: array
                  items:
                    $ref: '#/components/schemas/CustomField'
                event_template:
                  $ref: '#/components/schemas/EventTemplate'
      responses:
        '200':
          description: Booking link updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookingLink'

    delete:
      operationId: deleteBookingLink
      summary: Delete a booking link
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Booking link deleted

  /booking-links/{id}/bookings:
    get:
      operationId: getBookingLinkBookings
      summary: Get bookings for a booking link
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Bookings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Booking'

  # Poll endpoints
  /polls:
    get:
      operationId: listPolls
      summary: List all polls
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Polls
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Poll'

    post:
      operationId: createPoll
      summary: Create a poll
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                description:
                  type: string
                show_results:
                  type: boolean
                require_email:
                  type: boolean
                custom_fields:
                  type: array
                  items:
                    $ref: '#/components/schemas/CustomField'
      responses:
        '201':
          description: Poll created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Poll'

  /polls/{id}:
    get:
      operationId: getPoll
      summary: Get poll details
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Poll details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Poll'

    put:
      operationId: updatePoll
      summary: Update a poll
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                status:
                  $ref: '#/components/schemas/LinkStatus'
                show_results:
                  type: boolean
                require_email:
                  type: boolean
                custom_fields:
                  type: array
                  items:
                    $ref: '#/components/schemas/CustomField'
      responses:
        '200':
          description: Poll updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Poll'

    delete:
      operationId: deletePoll
      summary: Delete a poll
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Poll deleted

  /polls/{id}/options:
    get:
      operationId: getPollOptions
      summary: Get options for a poll
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Poll options
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PollOption'

    post:
      operationId: addPollOption
      summary: Add an option to a poll
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, start_time, end_time]
              properties:
                type:
                  $ref: '#/components/schemas/SlotType'
                start_time:
                  type: string
                  format: date-time
                end_time:
                  type: string
                  format: date-time
      responses:
        '201':
          description: Option added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PollOption'

  /polls/{id}/options/{optionId}:
    delete:
      operationId: deletePollOption
      summary: Delete an option from a poll
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: optionId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Option deleted

  /polls/{id}/votes:
    get:
      operationId: getPollVotes
      summary: Get votes for a poll
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Votes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Vote'

  /polls/{id}/pick-winner:
    post:
      operationId: pickPollWinner
      summary: Pick winning option for poll
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [option_id]
              properties:
                option_id:
                  type: integer
      responses:
        '200':
          description: Winner picked

  # Booking management endpoints
  /bookings/{id}/approve:
    post:
      operationId: approveBooking
      summary: Approve a booking
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Booking approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Booking'

  /bookings/{id}/decline:
    post:
      operationId: declineBooking
      summary: Decline a booking
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Booking declined
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Booking'

  # Public booking endpoints
  /p/booking/{slug}:
    get:
      operationId: getPublicBookingLink
      summary: Get public booking link info
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Booking link info
          content:
            application/json:
              schema:
                type: object
                required: [name]
                properties:
                  name:
                    type: string
                  description:
                    type: string
                  custom_fields:
                    type: array
                    items:
                      $ref: '#/components/schemas/CustomField'
                  require_email:
                    type: boolean
                  slot_durations_minutes:
                    type: array
                    items:
                      type: integer
                    description: Available slot durations in minutes
                  organizer_name:
                    type: string
                    description: Display name of the organizer
                  organizer_avatar_url:
                    type: string
                    description: URL to the organizer's avatar image
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /p/booking/{slug}/availability:
    get:
      operationId: getBookingAvailability
      summary: Get real-time availability for booking link
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: start
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: end
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: duration
          in: query
          required: false
          schema:
            type: integer
            minimum: 5
            maximum: 480
          description: Filter availability by slot duration in minutes
      responses:
        '200':
          description: Available slots
          content:
            application/json:
              schema:
                type: object
                required: [slots]
                properties:
                  slots:
                    type: array
                    items:
                      $ref: '#/components/schemas/Slot'

  /p/booking/{slug}/book:
    post:
      operationId: createBooking
      summary: Create a booking
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [guest_email, start_time, end_time]
              properties:
                guest_email:
                  type: string
                  format: email
                guest_name:
                  type: string
                start_time:
                  type: string
                  format: date-time
                  description: Start time of the requested slot
                end_time:
                  type: string
                  format: date-time
                  description: End time of the requested slot
                custom_fields:
                  type: object
                  additionalProperties:
                    type: string
      responses:
        '201':
          description: Booking created
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    $ref: '#/components/schemas/BookingStatus'
                  message:
                    type: string
        '409':
          description: Slot unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Public poll endpoints
  /p/poll/{slug}:
    get:
      operationId: getPublicPoll
      summary: Get public poll info
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Poll info
          content:
            application/json:
              schema:
                type: object
                required: [name, options]
                properties:
                  name:
                    type: string
                  description:
                    type: string
                  custom_fields:
                    type: array
                    items:
                      $ref: '#/components/schemas/CustomField'
                  options:
                    type: array
                    items:
                      $ref: '#/components/schemas/PollOption'
                  show_results:
                    type: boolean
                  require_email:
                    type: boolean
                  organizer_name:
                    type: string
                    description: Display name of the organizer
                  organizer_avatar_url:
                    type: string
                    description: URL to the organizer's avatar image
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /p/poll/{slug}/vote:
    post:
      operationId: submitVote
      summary: Submit poll vote
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [responses]
              properties:
                guest_name:
                  type: string
                guest_email:
                  type: string
                  format: email
                responses:
                  type: object
                  additionalProperties:
                    $ref: '#/components/schemas/VoteResponse'
                custom_fields:
                  type: object
                  additionalProperties:
                    type: string
      responses:
        '201':
          description: Vote submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vote'

  /p/poll/{slug}/results:
    get:
      operationId: getPollResults
      summary: Get poll results
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Poll results
          content:
            application/json:
              schema:
                type: object
                required: [tally]
                properties:
                  tally:
                    type: array
                    items:
                      $ref: '#/components/schemas/VoteTally'
                  votes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Vote'
        '403':
          description: Results not public
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Email action endpoints
  /actions/approve:
    get:
      operationId: approveViaEmail
      summary: Approve booking via email link
      security:
        - actionToken: []
      responses:
        '200':
          description: Booking approved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /actions/decline:
    get:
      operationId: declineViaEmail
      summary: Decline booking via email link
      security:
        - actionToken: []
      responses:
        '200':
          description: Booking declined
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
